<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Log Station v5.3.2 - Alfred CL7ADV</title>
    <style>
        :root {
            --bg-dark: #050a14;
            --panel-bg: #0d1b2a;
            --neon-cyan: #00e5ff;
            --neon-pink: #ff007f;
            --neon-yellow: #ffea00;
            --neon-green: #00ff88;
            --text-main: #e6f1ff;
            --card-bg: rgba(20, 33, 61, 0.9);
            --sunrise: linear-gradient(0deg, #ff7e5f 0%, #feb47b 50%, #050a14 100%);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body, html {
            height: 100%;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow: hidden;
            position: relative;
        }

        /* MARCA DE AGUA DEL CREADOR */
        .watermark {
            position: fixed;
            bottom: 15px;
            right: 15px;
            font-size: 0.75rem;
            color: rgba(0, 229, 255, 0.5);
            z-index: 3000;
            pointer-events: none;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(0, 229, 255, 0.4);
            font-family: 'Courier New', Courier, monospace;
        }

        /* PANTALLA DE INTRODUCCI√ìN */
        #intro-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--sunrise);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 1.5s ease, visibility 1.5s;
        }

        .sun {
            width: 100px; height: 100px;
            background: #fffbe6;
            border-radius: 50%;
            box-shadow: 0 0 50px #ffea00, 0 0 100px #ff7e5f;
            margin-bottom: 20px;
            animation: pulse 3s infinite alternate;
        }

        @keyframes pulse { from { transform: scale(1); opacity: 0.8; } to { transform: scale(1.1); opacity: 1; } }

        .intro-text {
            font-size: 1.5rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 5px;
            color: white;
            text-shadow: 0 0 20px rgba(0,0,0,0.5);
            text-align: center;
        }

        /* CONTENIDO PRINCIPAL */
        #main-content {
            height: 100%;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transition: opacity 2s ease;
            overflow-y: auto;
        }

        header {
            background: rgba(13, 27, 42, 0.95);
            padding: 10px 15px;
            text-align: center;
            border-bottom: 2px solid var(--neon-cyan);
            box-shadow: 0 0 15px var(--neon-cyan);
            position: sticky; top: 0; z-index: 100;
        }

        .time-display {
            font-family: 'Courier New', Courier, monospace;
            color: var(--neon-green);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .container { padding: 20px; max-width: 1200px; margin: 0 auto; width: 100%; }

        /* MENU CASILLAS */
        .grid-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
        }

        .menu-item {
            background: var(--panel-bg);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100px; opacity: 0.7;
        }

        .menu-item:hover { transform: scale(1.02); opacity: 1; border-color: var(--neon-cyan); }
        
        .menu-item.active-item {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 15px var(--neon-cyan), inset 0 0 10px rgba(0, 229, 255, 0.2);
            background: #1b263b; opacity: 1; transform: translateY(-2px);
        }

        .menu-item .number { position: absolute; top: 5px; left: 8px; font-size: 0.75rem; color: var(--neon-pink); font-weight: bold; }
        .menu-item i { font-size: 1.6rem; margin-bottom: 6px; color: var(--neon-yellow); }

        /* PANELES */
        .log-entry-panel {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            border-top: 3px solid var(--neon-pink);
            margin-bottom: 20px;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .active-panel { display: block; animation: slideUp 0.4s ease; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-group { display: flex; flex-direction: column; margin-bottom: 10px; }
        
        label { font-size: 0.7rem; color: var(--neon-cyan); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }

        input, select {
            background: rgba(27, 38, 59, 0.8);
            border: 1px solid #444;
            color: white;
            padding: 12px;
            border-radius: 8px;
            outline: none;
            transition: 0.3s;
        }

        input:focus { border-color: var(--neon-green); box-shadow: 0 0 10px rgba(0,255,136,0.3); }

        .btn {
            padding: 14px 20px; border: none; border-radius: 8px; cursor: pointer;
            font-weight: bold; text-transform: uppercase; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        .btn-pink { background: var(--neon-pink); color: #fff; }
        .btn-green { background: var(--neon-green); color: #000; }
        .btn-cyan { background: var(--neon-cyan); color: #000; }

        .table-container { width: 100%; overflow-x: auto; background: rgba(0,0,0,0.3); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; font-size: 0.85rem; }
        th { background: var(--panel-bg); color: var(--neon-yellow); text-align: left; padding: 12px; border-bottom: 2px solid var(--neon-cyan); }
        td { padding: 10px; border-bottom: 1px solid #222; }
        tr:hover { background: rgba(0,229,255,0.05); }

        .action-btn { background: none; border: none; cursor: pointer; font-size: 1.1rem; padding: 5px; transition: 0.2s; }
        .action-btn:hover { transform: scale(1.2); }

        @media (max-width: 600px) {
            .grid-menu { grid-template-columns: repeat(2, 1fr); }
            .form-row { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

<!-- FIRMA DE AGUA -->
<div class="watermark">CL7ADV-CUBA Creador</div>

<!-- PANTALLA INTRO -->
<div id="intro-screen">
    <div class="sun"></div>
    <div class="intro-text">
        Amanecer en el Caribe<br>
        <span style="font-size: 0.8rem; letter-spacing: 2px; color: var(--neon-cyan);">Cargando Estaci√≥n de Alfred CL7ADV...</span>
    </div>
</div>

<div id="main-content">
    <header>
        <h1 style="font-size: 1.3rem;">NEON LOG STATION v5.3.2</h1>
        <p style="font-size: 0.8rem;">Op: <span id="header-op" style="color:var(--neon-yellow)">---</span> | <span id="header-count">0</span> QSOs registrados</p>
        <div id="clock" class="time-display">00:00:00 UTC</div>
    </header>

    <div class="container">
        <!-- CASILLAS -->
        <div class="grid-menu">
            <div id="btn-op" class="menu-item" onclick="togglePanel('panel-op', 'btn-op')">
                <span class="number">00</span><i>üë§</i><span>Operador</span>
            </div>
            <div id="btn-log" class="menu-item active-item" onclick="togglePanel('panel-log', 'btn-log')">
                <span class="number">01</span><i>üìù</i><span>Nuevo QSO</span>
            </div>
            <div id="btn-table" class="menu-item" onclick="togglePanel('panel-table', 'btn-table')">
                <span class="number">02</span><i>üìã</i><span>Libro</span>
            </div>
            <div id="btn-import" class="menu-item" onclick="togglePanel('panel-import', 'btn-import')">
                <span class="number">03</span><i>üì•</i><span>Importar</span>
            </div>
            <div id="btn-export" class="menu-item" onclick="exportADIF()">
                <span class="number">04</span><i>üíæ</i><span>Exportar</span>
            </div>
            <div id="btn-clear" class="menu-item" onclick="clearLogs()">
                <span class="number">05</span><i>üóëÔ∏è</i><span>Limpiar</span>
            </div>
        </div>

        <!-- PANEL OPERADOR -->
        <div id="panel-op" class="log-entry-panel">
            <h3 style="color: var(--neon-yellow); margin-bottom: 15px;">Ajustes Estaci√≥n</h3>
            <div class="form-row">
                <div class="form-group"><label>Tu Indicativo</label><input type="text" id="op_call" placeholder="CL7ADV" oninput="saveOperatorData()"></div>
                <div class="form-group"><label>Tu Nombre</label><input type="text" id="op_name" placeholder="Alfred" oninput="saveOperatorData()"></div>
                <div class="form-group"><label>Tu Grilla</label><input type="text" id="op_grid" placeholder="FL01aa" oninput="saveOperatorData()"></div>
            </div>
        </div>

        <!-- PANEL NUEVO/EDITAR QSO -->
        <div id="panel-log" class="log-entry-panel active-panel">
            <h3 id="panel-title" style="color: var(--neon-pink); margin-bottom: 15px;">Registro de Contacto</h3>
            <input type="hidden" id="edit_id">
            <div class="form-row">
                <div class="form-group" style="grid-column: span 2;">
                    <label>Callsign Corresponsal</label>
                    <input type="text" id="call" placeholder="Indicativo" onkeyup="this.value = this.value.toUpperCase()">
                </div>
                <div class="form-group">
                    <label>Frecuencia (MHz)</label>
                    <input type="text" id="freq" placeholder="7.150">
                </div>
                <div class="form-group">
                    <label>Banda</label>
                    <select id="band">
                        <option value="40M">40M</option><option value="20M">20M</option>
                        <option value="15M">15M</option><option value="10M">10M</option>
                        <option value="6M">6M</option><option value="2M">2M</option>
                        <option value="70CM">70CM</option><option value="23CM">23CM</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Modo</label>
                    <input list="modes" id="mode" placeholder="Modo...">
                    <datalist id="modes">
                        <option value="SSB"><option value="FM"><option value="CW"><option value="FT8">
                        <option value="FT4"><option value="Digital Voice"><option value="DMR">
                        <option value="RTTY"><option value="JS8">
                    </datalist>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Fecha UTC (Ej: 20240520)</label>
                    <input type="text" id="manual_date" placeholder="Auto si vac√≠o">
                </div>
                <div class="form-group">
                    <label>Hora UTC (Ej: 143005)</label>
                    <input type="text" id="manual_time" placeholder="Auto si vac√≠o">
                </div>
                <div class="form-group"><label>Sent</label><input type="text" id="rst_s" value="59"></div>
                <div class="form-group"><label>Rcvd</label><input type="text" id="rst_r" value="59"></div>
            </div>

            <div class="form-group">
                <label>Comentarios / Nombre</label>
                <input type="text" id="comment" placeholder="Ej: Juan de Camaguey...">
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button id="save-btn" class="btn btn-pink" onclick="saveQSO()" style="flex: 2;">üíæ Guardar Registro</button>
                <button id="cancel-edit" class="btn btn-cyan" onclick="resetForm()" style="flex: 1; display: none;">Cancelar</button>
            </div>
        </div>

        <!-- PANEL TABLA -->
        <div id="panel-table" class="log-entry-panel">
            <h3 style="color: var(--neon-cyan); margin-bottom: 10px;">Libro de Guardia</h3>
            <input type="text" id="search" class="search-box" placeholder="üîé Filtrar por indicativo..." oninput="renderTable()" style="width:100%; padding:10px; background:#000; border:1px solid var(--neon-cyan); color:var(--neon-green); margin-bottom:15px; border-radius:5px;">
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>Fecha/Hora UTC</th><th>Callsign</th><th>Freq</th><th>Banda</th><th>Modo</th><th>RST</th><th>Acci√≥n</th></tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- PANEL IMPORTAR -->
        <div id="panel-import" class="log-entry-panel">
            <h3 style="color: var(--neon-green); margin-bottom: 15px;">Importar ADIF</h3>
            <input type="file" id="import-file" style="display: none;" onchange="processImport(this)">
            <button class="btn btn-green" onclick="document.getElementById('import-file').click()" style="width: 100%;">üìÅ Abrir Archivo .adi</button>
        </div>
    </div>
</div>

<script>
    // Almacenamiento e Inicializaci√≥n
    let qsoList = JSON.parse(localStorage.getItem('cl7adv_logs_v5_stable')) || [];
    let opData = JSON.parse(localStorage.getItem('cl7adv_operator_stable')) || { call: "", name: "", grid: "" };

    // Animaci√≥n de entrada
    window.addEventListener('load', () => {
        setTimeout(() => {
            const intro = document.getElementById('intro-screen');
            const main = document.getElementById('main-content');
            intro.style.opacity = '0';
            setTimeout(() => {
                intro.style.visibility = 'hidden';
                main.style.opacity = '1';
                document.body.style.overflow = 'auto';
            }, 1500);
        }, 1500); 
    });

    // SISTEMA DE TIEMPO S√ìLIDO (UTC)
    function getUTCString() {
        const now = new Date();
        const y = now.getUTCFullYear();
        const m = (now.getUTCMonth() + 1).toString().padStart(2, '0');
        const d = now.getUTCDate().toString().padStart(2, '0');
        const hh = now.getUTCHours().toString().padStart(2, '0');
        const mm = now.getUTCMinutes().toString().padStart(2, '0');
        const ss = now.getUTCSeconds().toString().padStart(2, '0');
        
        return {
            date: `${y}${m}${d}`,
            time: `${hh}${mm}${ss}`,
            display: `${hh}:${mm}:${ss}`
        };
    }

    function updateClock() {
        document.getElementById('clock').textContent = getUTCString().display + " UTC";
    }
    setInterval(updateClock, 1000);

    // Manejo de Paneles
    function togglePanel(panelId, buttonId) {
        document.querySelectorAll('.log-entry-panel').forEach(p => p.classList.remove('active-panel'));
        document.querySelectorAll('.menu-item').forEach(b => b.classList.remove('active-item'));
        document.getElementById(panelId).classList.add('active-panel');
        document.getElementById(buttonId).classList.add('active-item');
        if(panelId === 'panel-table') renderTable();
    }

    function saveOperatorData() {
        opData.call = document.getElementById('op_call').value.toUpperCase();
        opData.name = document.getElementById('op_name').value;
        opData.grid = document.getElementById('op_grid').value.toUpperCase();
        localStorage.setItem('cl7adv_operator_stable', JSON.stringify(opData));
        document.getElementById('header-op').textContent = opData.call || "---";
    }

    // SISTEMA DE GUARDADO ROBUSTO
    function saveQSO() {
        const call = document.getElementById('call').value.trim().toUpperCase();
        if(!call) {
            alert("Error: El indicativo es obligatorio.");
            return;
        }

        const utcNow = getUTCString();
        const editId = document.getElementById('edit_id').value;
        
        // Validaci√≥n de datos manuales
        let finalDate = document.getElementById('manual_date').value.trim();
        let finalTime = document.getElementById('manual_time').value.trim();

        // Si est√°n vac√≠os, usar UTC actual. Si no, limpiar caracteres no num√©ricos.
        finalDate = finalDate === "" ? utcNow.date : finalDate.replace(/\D/g, '').substring(0, 8);
        finalTime = finalTime === "" ? utcNow.time : finalTime.replace(/\D/g, '').substring(0, 6);

        const qso = {
            id: editId ? parseInt(editId) : Date.now(),
            call: call,
            freq: document.getElementById('freq').value.trim(),
            band: document.getElementById('band').value,
            mode: document.getElementById('mode').value.toUpperCase() || "SSB",
            rst_s: document.getElementById('rst_s').value.trim() || "59",
            rst_r: document.getElementById('rst_r').value.trim() || "59",
            date: finalDate,
            time: finalTime,
            comment: document.getElementById('comment').value.trim()
        };

        if (editId) {
            const index = qsoList.findIndex(q => q.id === qso.id);
            if (index !== -1) {
                qsoList[index] = qso;
                alert("Registro actualizado.");
            }
        } else {
            qsoList.unshift(qso);
            alert("QSO grabado con √©xito.");
        }

        localStorage.setItem('cl7adv_logs_v5_stable', JSON.stringify(qsoList));
        resetForm();
        updateCount();
        if(editId) togglePanel('panel-table', 'btn-table');
    }

    function resetForm() {
        document.getElementById('edit_id').value = "";
        document.getElementById('call').value = "";
        document.getElementById('comment').value = "";
        document.getElementById('manual_date').value = "";
        document.getElementById('manual_time').value = "";
        document.getElementById('freq').value = "";
        document.getElementById('rst_s').value = "59";
        document.getElementById('rst_r').value = "59";
        
        document.getElementById('panel-title').textContent = "Registro de Contacto";
        document.getElementById('panel-title').style.color = "var(--neon-pink)";
        document.getElementById('save-btn').textContent = "üíæ Guardar Registro";
        document.getElementById('cancel-edit').style.display = "none";
    }

    // CARGA DE EDICI√ìN SIN ERRORES
    function editQSO(id) {
        const q = qsoList.find(item => item.id === id);
        if (!q) return;

        document.getElementById('edit_id').value = q.id;
        document.getElementById('call').value = q.call;
        document.getElementById('freq').value = q.freq;
        document.getElementById('band').value = q.band;
        document.getElementById('mode').value = q.mode;
        document.getElementById('rst_s').value = q.rst_s;
        document.getElementById('rst_r').value = q.rst_r;
        document.getElementById('manual_date').value = q.date;
        document.getElementById('manual_time').value = q.time;
        document.getElementById('comment').value = q.comment;

        document.getElementById('panel-title').textContent = "Editando Registro";
        document.getElementById('panel-title').style.color = "var(--neon-cyan)";
        document.getElementById('save-btn').textContent = "‚úÖ Actualizar Registro";
        document.getElementById('cancel-edit').style.display = "block";

        togglePanel('panel-log', 'btn-log');
    }

    function renderTable() {
        const f = document.getElementById('search').value.toUpperCase();
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = "";
        
        const filtered = qsoList.filter(q => q.call.includes(f));
        
        filtered.forEach(q => {
            tbody.innerHTML += `<tr>
                <td style="font-family:monospace">${q.date} | ${q.time}</td>
                <td style="color:var(--neon-yellow); font-weight:bold">${q.call}</td>
                <td style="color:var(--neon-green)">${q.freq || '---'}</td>
                <td>${q.band}</td>
                <td>${q.mode}</td>
                <td>${q.rst_s}/${q.rst_r}</td>
                <td>
                    <button title="Editar" class="action-btn" onclick="editQSO(${q.id})">‚úèÔ∏è</button>
                    <button title="Borrar" class="action-btn" onclick="deleteQSO(${q.id})" style="color:red">‚ùå</button>
                </td>
            </tr>`;
        });
    }

    function deleteQSO(id) {
        if(confirm("¬øSeguro que deseas eliminar este registro?")) {
            qsoList = qsoList.filter(q => q.id !== id);
            localStorage.setItem('cl7adv_logs_v5_stable', JSON.stringify(qsoList));
            renderTable();
            updateCount();
        }
    }

    function updateCount() { 
        document.getElementById('header-count').textContent = qsoList.length; 
    }

    function exportADIF() {
        if(qsoList.length === 0) return alert("El libro est√° vac√≠o.");
        
        let adi = `ADIF Export - NEON LOG STATION v5.3.2\n`;
        adi += `<PROGRAMID:12>NEONLOGSTN53\n<ADIF_VER:5>3.1.4\n<EOH>\n\n`;

        qsoList.forEach(q => {
            adi += `<CALL:${q.call.length}>${q.call}`;
            adi += `<QSO_DATE:${q.date.length}>${q.date}`;
            adi += `<TIME_ON:${q.time.length}>${q.time}`;
            adi += `<BAND:${q.band.length}>${q.band}`;
            adi += `<MODE:${q.mode.length}>${q.mode}`;
            adi += `<RST_SENT:${q.rst_s.length}>${q.rst_s}`;
            adi += `<RST_RCVD:${q.rst_r.length}>${q.rst_r}`;
            if(q.freq) adi += `<FREQ:${q.freq.length}>${q.freq}`;
            if(q.comment) adi += `<COMMENT:${q.comment.length}>${q.comment}`;
            if(opData.call) adi += `<STATION_CALLSIGN:${opData.call.length}>${opData.call}`;
            if(opData.name) adi += `<OPERATOR:${opData.name.length}>${opData.name}`;
            adi += `<EOR>\n`;
        });

        const blob = new Blob([adi], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Log_Alfred_CL7ADV_${getUTCString().date}.adi`;
        a.click();
    }

    function processImport(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const records = text.split(/<EOR>|<eor>/i);
            let count = 0;
            records.forEach(rec => {
                const getF = (tag) => {
                    const regex = new RegExp(`<${tag}:\\d+>(.*?)(?=<|$)`, 'i');
                    const match = rec.match(regex);
                    return match ? match[1].trim() : "";
                };
                const call = getF('CALL');
                if(call) {
                    qsoList.push({
                        id: Date.now() + Math.floor(Math.random() * 10000),
                        call: call.toUpperCase(),
                        band: getF('BAND'),
                        mode: getF('MODE') || "SSB",
                        freq: getF('FREQ'),
                        rst_s: getF('RST_SENT') || "59",
                        rst_r: getF('RST_RCVD') || "59",
                        date: getF('QSO_DATE') || getUTCString().date,
                        time: getF('TIME_ON') || getUTCString().time,
                        comment: getF('COMMENT')
                    });
                    count++;
                }
            });
            localStorage.setItem('cl7adv_logs_v5_stable', JSON.stringify(qsoList));
            alert(`Importados ${count} QSOs.`);
            updateCount();
            togglePanel('panel-table', 'btn-table');
        };
        reader.readAsText(file);
    }

    function clearLogs() { 
        if(confirm("¬øBorrar TODO el libro de guardia? Esta acci√≥n no se puede deshacer.")) { 
            qsoList = []; 
            localStorage.setItem('cl7adv_logs_v5_stable', JSON.stringify([])); 
            updateCount(); 
            renderTable(); 
        } 
    }

    window.onload = function() {
        document.getElementById('op_call').value = opData.call;
        document.getElementById('op_name').value = opData.name;
        document.getElementById('op_grid').value = opData.grid;
        document.getElementById('header-op').textContent = opData.call || "---";
        updateCount();
        updateClock();
    }
</script>
</body>
</html>
