<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CODE TO MORSE PRO | Professional CW Station</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap');

        :root {
            --neon-green: #00ff41;
            --dark-bg: #050505;
            --panel-bg: #121212;
            --border-glow: rgba(0, 255, 65, 0.3);
            --danger: #ff3e3e;
            --cyan: #00f2ff;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--neon-green);
            font-family: 'Share Tech Mono', monospace;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }

        /* --- Layout Estructura --- */
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr 300px;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .header-station {
            grid-column: 1 / -1;
            text-align: center;
            border: 2px solid var(--neon-green);
            padding: 10px;
            background: linear-gradient(90deg, transparent, var(--border-glow), transparent);
            box-shadow: 0 0 15px var(--border-glow);
            margin-bottom: 20px;
        }

        .header-station h1 {
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            letter-spacing: 5px;
            text-transform: uppercase;
        }

        .panel {
            background: var(--panel-bg);
            border: 1px solid var(--neon-green);
            padding: 15px;
            border-radius: 4px;
            box-shadow: inset 0 0 10px #000;
            position: relative;
        }

        /* --- Gráficos Avanzados --- */
        .canvas-container {
            background: #000;
            border: 1px solid #333;
            height: 150px;
            margin-bottom: 10px;
            position: relative;
        }

        canvas {
            width: 100%;
            height: 100%;
        }

        .label-overlay {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 10px;
            color: var(--cyan);
            pointer-events: none;
        }

        /* --- Consola de Texto --- */
        .terminal {
            background: #000;
            border: 1px solid #222;
            color: #fff;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-size: 1.2rem;
            line-height: 1.5;
            margin: 10px 0;
        }

        .morse-live {
            color: var(--cyan);
            height: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        /* --- Controles --- */
        .control-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 12px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        input[type="range"] {
            -webkit-appearance: none;
            background: #222;
            height: 4px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 15px;
            height: 15px;
            background: var(--neon-green);
            cursor: pointer;
            box-shadow: 0 0 5px var(--neon-green);
        }

        button {
            background: transparent;
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            padding: 10px;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            margin-top: 5px;
        }

        button:hover {
            background: var(--neon-green);
            color: #000;
            box-shadow: 0 0 20px var(--neon-green);
        }

        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: #fff; box-shadow: 0 0 20px var(--danger); }

        /* --- Indicadores --- */
        .led-panel {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background: #000;
            margin-bottom: 10px;
        }

        .indicator {
            text-align: center;
            font-size: 10px;
        }

        .led {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #1a1a1a;
            margin: 0 auto 5px;
            border: 1px solid #333;
        }

        .led.on { background: var(--neon-green); box-shadow: 0 0 15px var(--neon-green); }
        .led.rx-on { background: var(--cyan); box-shadow: 0 0 15px var(--cyan); }

        /* --- Log de Estación --- */
        .station-log {
            font-size: 11px;
            color: #666;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            border-bottom: 1px solid #222;
            padding: 5px 0;
        }

        .log-time { color: var(--cyan); }

        /* Estilo para el área de texto TX */
        #txInput {
            width: 100%;
            height: 80px;
            background: #000;
            color: var(--neon-green);
            border: 1px solid #333;
            padding: 10px;
            box-sizing: border-box;
            resize: none;
            font-family: 'Share Tech Mono', monospace;
        }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--neon-green); }
    </style>
</head>
<body>

<div class="header-station">
    <h1>CODE TO MORSE PRO - MULTI-TOOL STATION</h1>
</div>

<div class="main-grid">
    <div class="panel">
        <h3>ESTACIÓN DE TRANSMISIÓN</h3>
        <div class="led-panel">
            <div class="indicator"><div id="txLed" class="led"></div>TX</div>
            <div class="indicator"><div id="powerLed" class="led on"></div>PWR</div>
        </div>

        <div class="control-group">
            <label>Velocidad (WPM) <span id="wpmVal">20</span></label>
            <input type="range" id="wpmSlider" min="5" max="50" value="20">
        </div>

        <div class="control-group">
            <label>Tono de Audio (Hz) <span id="pitchVal">700</span></label>
            <input type="range" id="pitchSlider" min="400" max="1200" value="700">
        </div>

        <div class="control-group">
            <label>Volumen <span id="volVal">50</span></label>
            <input type="range" id="volSlider" min="0" max="100" value="50">
        </div>

        <textarea id="txInput" placeholder="INTRODUZCA MENSAJE PARA CW..."></textarea>
        <button onclick="transmitMessage()" style="width: 100%;">TRANSMITIR CW</button>
        <button onclick="stopTX()" class="btn-danger" style="width: 100%;">ABORTAR TX</button>
        
        <div style="margin-top: 20px;">
            <h4>ACCIONES RÁPIDAS</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <button onclick="quickTX('CQ CQ CQ DE EA1XYZ')">CQ CQ</button>
                <button onclick="quickTX('73 ES GL SK')">73 ES GL</button>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="canvas-container">
            <div class="label-overlay">SPECTRUM ANALYZER (FFT)</div>
            <canvas id="freqCanvas"></canvas>
        </div>
        <div class="canvas-container">
            <div class="label-overlay">WAVEFORM (TIME DOMAIN)</div>
            <canvas id="timeCanvas"></canvas>
        </div>

        <div class="morse-live" id="morseBuffer">...</div>
        <div class="terminal" id="rxTerminal"></div>
        
        <div style="display: flex; gap: 10px;">
            <button onclick="initAudio()" id="startBtn" style="flex: 1;">INICIAR SISTEMA DE AUDIO</button>
            <button onclick="clearTerminal()" style="flex: 0.3;">CLEAR</button>
        </div>
    </div>

    <div class="panel">
        <h3>RX CONFIGURATION</h3>
        <div class="led-panel">
            <div class="indicator"><div id="rxLed" class="led"></div>RX</div>
            <div class="indicator"><div id="signalLed" class="led"></div>SIGNAL</div>
        </div>

        <div class="control-group">
            <label>Umbral Squelch <span id="sqVal">120</span></label>
            <input type="range" id="sqSlider" min="0" max="255" value="120">
        </div>

        <div class="control-group">
            <label>Ancho Filtro (Hz) <span id="bwVal">100</span></label>
            <input type="range" id="bwSlider" min="10" max="500" value="100">
        </div>

        <h4>LOG DE ESTACIÓN</h4>
        <div class="station-log" id="logList">
            <div class="log-entry">ESTACIÓN INICIALIZADA. ESPERANDO DATOS...</div>
        </div>
    </div>
</div>

<script>
    /**
     * MÓDULO 1: DICCIONARIO Y VARIABLES GLOBALES
     */
    const MORSE_LIB = {
        '.-': 'A', '-...': 'B', '-.-.': 'C', '-..': 'D', '.': 'E', '..-.': 'F', '--.': 'G', '....': 'H',
        '..': 'I', '.---': 'J', '-.-': 'K', '.-..': 'L', '--': 'M', '-.': 'N', '---': 'O', '.--.': 'P',
        '--.-': 'Q', '.-.': 'R', '...': 'S', '-': 'T', '..-': 'U', '...-': 'V', '.--': 'W', '-..-': 'X',
        '-.--': 'Y', '--..': 'Z', '.----': '1', '..---': '2', '...--': '3', '....-': '4', '.....': '5',
        '-....': '6', '--...': '7', '---..': '8', '----.': '9', '-----': '0', '.-.-.-': '.', '--..--': ',',
        '..--..': '?', '-....-': '-', '-..-.': '/', '---...': ':', '.----.': "'", '-.-.--': '!'
    };
    const TEXT_TO_MORSE = Object.fromEntries(Object.entries(MORSE_LIB).map(([k, v]) => [v, k]));

    let audioCtx, analyzer, microphone, biquadFilter, gainNode;
    let isTxRunning = false;
    let systemInitialized = false;

    // Variables de decodificación
    let signalActive = false;
    let signalStartTime = 0;
    let silenceStartTime = Date.now();
    let currentSymbols = "";

    /**
     * MÓDULO 2: INICIALIZACIÓN DE AUDIO AVANZADO
     */
    async function initAudio() {
        if (systemInitialized) return;
        
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            microphone = audioCtx.createMediaStreamSource(stream);
            
            // Filtro Biquad para aislar el CW
            biquadFilter = audioCtx.createBiquadFilter();
            biquadFilter.type = "bandpass";
            biquadFilter.frequency.value = document.getElementById('pitchSlider').value;
            biquadFilter.Q.value = 5;

            analyzer = audioCtx.createAnalyser();
            analyzer.fftSize = 1024;

            microphone.connect(biquadFilter);
            biquadFilter.connect(analyzer);

            addLog("MICRÓFONO CONECTADO Y FILTROS ACTIVOS.");
            systemInitialized = true;
            document.getElementById('startBtn').innerText = "AUDIO ONLINE";
            document.getElementById('startBtn').style.borderColor = "var(--cyan)";
            
            drawVisuals();
            processRX();
        } catch (e) {
            addLog("ERROR: ACCESO A AUDIO DENEGADO.");
        }
    }

    /**
     * MÓDULO 3: PROCESAMIENTO DE SEÑAL Y TRADUCCIÓN
     */
    function processRX() {
        const dataArray = new Uint8Array(analyzer.frequencyBinCount);
        analyzer.getByteFrequencyData(dataArray);

        // Encontrar energía en el tono objetivo
        const freq = document.getElementById('pitchSlider').value;
        const index = Math.floor(freq / (audioCtx.sampleRate / analyzer.fftSize));
        const magnitude = dataArray[index];
        const threshold = document.getElementById('sqSlider').value;

        const isPressed = magnitude > threshold;
        const now = Date.now();

        if (isPressed !== signalActive) {
            if (isPressed) {
                // Inicio de pulso
                const silenceDuration = now - silenceStartTime;
                if (silenceDuration > 600) appendToTerminal(" ");
                signalStartTime = now;
                document.getElementById('rxLed').classList.add('rx-on');
                document.getElementById('signalLed').classList.add('on');
            } else {
                // Fin de pulso
                const duration = now - signalStartTime;
                if (duration > 20 && duration < 250) currentSymbols += ".";
                else if (duration >= 250) currentSymbols += "-";
                
                document.getElementById('morseBuffer').innerText = currentSymbols;
                document.getElementById('rxLed').classList.remove('rx-on');
                document.getElementById('signalLed').classList.remove('on');
            }
            signalActive = isPressed;
        }

        if (!isPressed && currentSymbols !== "") {
            const silenceDuration = now - silenceStartTime;
            if (silenceDuration > 300) {
                const char = MORSE_LIB[currentSymbols] || "?";
                appendToTerminal(char);
                currentSymbols = "";
                document.getElementById('morseBuffer').innerText = "";
            }
        }

        if (!isPressed) silenceStartTime = now;
        
        // Mantener filtro actualizado
        biquadFilter.frequency.value = document.getElementById('pitchSlider').value;
        biquadFilter.Q.value = 1000 / document.getElementById('bwSlider').value;

        requestAnimationFrame(processRX);
    }

    /**
     * MÓDULO 4: TRANSMISIÓN (TX)
     */
    async function transmitMessage() {
        if (!systemInitialized || isTxRunning) {
            alert("Inicie el audio primero.");
            return;
        }
        
        isTxRunning = true;
        const text = document.getElementById('txInput').value.toUpperCase();
        addLog("TX INICIADO: " + text);
        
        const wpm = document.getElementById('wpmSlider').value;
        const unit = 1200 / wpm;
        const freq = document.getElementById('pitchSlider').value;

        for (let char of text) {
            if (!isTxRunning) break;
            const code = TEXT_TO_MORSE[char] || (char === " " ? "/" : "");
            
            for (let s of code) {
                if (!isTxRunning) break;
                if (s === ".") await oscillatorBeep(unit, freq);
                else if (s === "-") await oscillatorBeep(unit * 3, freq);
                else if (s === "/") await sleep(unit * 7);
                await sleep(unit);
            }
            await sleep(unit * 3);
        }
        isTxRunning = false;
        addLog("TX FINALIZADO.");
    }

    function oscillatorBeep(dur, freq) {
        return new Promise(res => {
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = "sine";
            osc.frequency.value = freq;
            
            g.gain.value = document.getElementById('volSlider').value / 100;
            osc.connect(g);
            g.connect(audioCtx.destination);
            
            document.getElementById('txLed').classList.add('on');
            osc.start();
            setTimeout(() => {
                osc.stop();
                document.getElementById('txLed').classList.remove('on');
                res();
            }, dur);
        });
    }

    /**
     * MÓDULO 5: GRÁFICOS Y CANVAS
     */
    function drawVisuals() {
        const freqCanvas = document.getElementById('freqCanvas');
        const fCtx = freqCanvas.getContext('2d');
        const timeCanvas = document.getElementById('timeCanvas');
        const tCtx = timeCanvas.getContext('2d');

        const bufferLength = analyzer.frequencyBinCount;
        const dataFreq = new Uint8Array(bufferLength);
        const dataTime = new Uint8Array(bufferLength);

        function render() {
            analyzer.getByteFrequencyData(dataFreq);
            analyzer.getByteTimeDomainData(dataTime);

            // Render Freq
            fCtx.fillStyle = '#000';
            fCtx.fillRect(0, 0, freqCanvas.width, freqCanvas.height);
            const barWidth = (freqCanvas.width / bufferLength) * 2.5;
            let x = 0;
            for(let i = 0; i < bufferLength; i++) {
                const barHeight = dataFreq[i] / 2;
                fCtx.fillStyle = `rgb(0, ${dataFreq[i] + 100}, 65)`;
                fCtx.fillRect(x, freqCanvas.height - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }

            // Render Time
            tCtx.fillStyle = '#000';
            tCtx.fillRect(0, 0, timeCanvas.width, timeCanvas.height);
            tCtx.lineWidth = 2;
            tCtx.strokeStyle = 'var(--neon-green)';
            tCtx.beginPath();
            const sliceWidth = timeCanvas.width * 1.0 / bufferLength;
            let tx = 0;
            for(let i = 0; i < bufferLength; i++) {
                const v = dataTime[i] / 128.0;
                const y = v * timeCanvas.height / 2;
                if(i === 0) tCtx.moveTo(tx, y);
                else tCtx.lineTo(tx, y);
                tx += sliceWidth;
            }
            tCtx.lineTo(timeCanvas.width, timeCanvas.height/2);
            tCtx.stroke();

            requestAnimationFrame(render);
        }
        render();
    }

    /**
     * MÓDULO 6: UTILIDADES
     */
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
    
    function appendToTerminal(text) {
        const term = document.getElementById('rxTerminal');
        term.innerText += text;
        term.scrollTop = term.scrollHeight;
    }

    function addLog(msg) {
        const log = document.getElementById('logList');
        const time = new Date().toLocaleTimeString();
        log.innerHTML = `<div class="log-entry"><span class="log-time">[${time}]</span> ${msg}</div>` + log.innerHTML;
    }

    function stopTX() { isTxRunning = false; addLog("TX INTERRUMPIDO."); }
    function clearTerminal() { document.getElementById('rxTerminal').innerText = ""; }
    function quickTX(msg) { document.getElementById('txInput').value = msg; transmitMessage(); }

    // Sync Sliders
    document.querySelectorAll('input[type="range"]').forEach(s => {
        s.addEventListener('input', (e) => {
            const spanId = e.target.id.replace('Slider', 'Val');
            if(document.getElementById(spanId)) document.getElementById(spanId).innerText = e.target.value;
        });
    });

</script>
</body>
</html>
